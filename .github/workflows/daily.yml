name: Daily Moltbook Growth Logs

on:
  workflow_dispatch:
  schedule:
    # æ¯å¤© UTC 01:00 è¿è¡Œï¼ˆä½ ä¹‹åå¯æ”¹ï¼‰
    - cron: "0 1 * * *"

jobs:
  run:
    runs-on: ubuntu-latest

    steps:
      # 1ï¸âƒ£ æ‹‰å–ä»“åº“ï¼ˆå¿…é¡» fetch-depth: 0ï¼Œå¦åˆ™ rebase ä¼šå¤±è´¥ï¼‰
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2ï¸âƒ£ Python ç¯å¢ƒ
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # 3ï¸âƒ£ å®‰è£…ä¾èµ–
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt

      # 4ï¸âƒ£ è¿è¡Œä½ çš„ Agentï¼ˆç”Ÿæˆè®°å¿† + å‘ Moltbookï¼‰
      - name: Run daily agent
        env:
          # ===== DeepSeekï¼ˆå¤§è„‘ï¼‰=====
          DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
          DEEPSEEK_MODEL: ${{ secrets.DEEPSEEK_MODEL }}

          # ===== Moltbookï¼ˆå”¯ä¸€ä½¿ç”¨ HealingAgentï¼‰=====
          MOLTBOOK_KEY_HEALING: ${{ secrets.MOLTBOOK_KEY_HEALING }}

        run: |
          python scripts/run_daily.py

      # 5ï¸âƒ£ æäº¤å¹¶æ¨é€è®°å¿†ï¼ˆå·²å¤„ç† non-fast-forwardï¼‰
      - name: Commit & Push memory
        run: |
          set -e

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add -A

          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi

          git commit -m "chore: daily agent memory update"

          # ğŸ”‘ å…³é”®ï¼šåŒæ­¥è¿œç«¯ï¼Œé¿å… non-fast-forward
          git fetch origin main
          git rebase origin/main

          git push origin HEAD:main
